# HistoAnalyzer ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π human-in-the-loop –∞–Ω–∞–ª–∏–∑ –≥–∏—Å—Ç–æ–ª–æ–≥–∏–∏

> ‚ö†Ô∏è **–ù–µ –¥–ª—è –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –î–ª—è —É—á–µ–±–Ω—ã—Ö/–Ω–∞—É—á–Ω—ã—Ö —Ü–µ–ª–µ–π.**

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
**–ú–∞—Å—Ç–µ—Ä –≤–µ–¥—ë—Ç, –ò–ò —Å–æ–≤–µ—Ç—É–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∞–µ—Ç.**
–ù–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –µ—Å—Ç—å **–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä** –∏ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å**, –±–µ–∑ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞.

## –§–∞–∑—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–≤ –∫–æ–¥–µ)
### –§–∞–∑–∞ 0
- –†—É—Å—Å–∫–∏–π UI, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π QMainWindow –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, toolbar/statusbar/dock.
- Zoom –ø–æ –∫—É—Ä—Å–æ—Ä—É, Space=–ø–∞–Ω–æ—Ä–∞–º–∞, double click=fit, Ctrl+0=100%.
- –û—Ç–∫—Ä—ã—Ç–∏–µ: –º–µ–Ω—é/drag&drop/CLI –∞—Ä–≥—É–º–µ–Ω—Ç.
- Recent files + —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞.

### –§–∞–∑–∞ 1
- –í–∫–ª–∞–¥–∫–∞ **üß≠ –ü–æ—à–∞–≥–æ–≤—ã–π –ò–ò** (0..11), —Å–æ—Å—Ç–æ—è–Ω–∏—è —à–∞–≥–æ–≤, done/reset/next.
- Preview/Apply –Ω–∞ —à–∞–≥–µ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç.
- –§–æ–Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ + –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É¬ª.

### –§–∞–∑—ã 2‚Äì8
- QC (—Ä–µ–∑–∫–æ—Å—Ç—å, –∫–ª–∏–ø–ø–∏–Ω–≥, —à—É–º, –≤–∏–Ω—å–µ—Ç–∫–∞, –¥–æ–ª—è —Ç–∫–∞–Ω–∏) + focus heatmap.
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫—Ä–∞—Å–∫–∏ (Reinhard; –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è).
- Illumination correction.
- Artifact mask (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞), ROI selector –ø–æ —Ç–∞–π–ª–∞–º.
- Perfect Enhance (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + —Ä—É—á–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ).
- –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è fallback CV –≤—Å–µ–≥–¥–∞ + optional backend (Cellpose/ONNX –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏).
- –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞.

### –§–∞–∑—ã 9‚Äì11
- –ú–æ—Ä—Ñ–æ–º–µ—Ç—Ä–∏—è —Å —Ä–µ–∂–∏–º–∞–º–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:
  1) –±–µ–∑ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏,
  2) –ø–æ –ª–∏–Ω–∏–∏,
  3) –ø–æ –º–∏–∫—Ä–æ–º–µ—Ç—Ä—É (–ø—Ä–æ—Ñ–∏–ª–∏ + 3 –ø–æ–≤—Ç–æ—Ä–∞ + SD).
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –¥–∏–∞–≥–Ω–æ–∑–æ–≤.
- –≠–∫—Å–ø–æ—Ä—Ç PDF/CSV/GeoJSON, recipe/audit –∏ batch –ø–æ —Ä–µ—Ü–µ–ø—Ç—É.

## –ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä (0..11)
0) –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–∑–æ—Ä
1) QC
2) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
3) –û—Å–≤–µ—â–µ–Ω–∏–µ
4) –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
5) ROI
6) –£–ª—É—á—à–µ–Ω–∏–µ
7) –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è
8) –ü–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥
9) –ú–æ—Ä—Ñ–æ–º–µ—Ç—Ä–∏—è –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
10) –û–ø–∏—Å–∞–Ω–∏–µ RU/EN (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞)
11) –≠–∫—Å–ø–æ—Ä—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

## –ó–∞–ø—É—Å–∫
```bash
python -m app
python -m app "C:\path\to\sample.histo"
python main.py
```

## FULL_AI (Windows)
- **FULL_AI –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ Python 3.11 (Windows).**
- –ó–∞–ø—É—Å–∫: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ `RUN_WINDOWS_FULL_AI.bat` –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞. –î–ª—è –ª—ë–≥–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `RUN_WINDOWS_LITE.bat`. –°–∫—Ä–∏–ø—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `py -3.11`, –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç `.venv` –ø—Ä–∏ –¥—Ä—É–≥–æ–π –≤–µ—Ä—Å–∏–∏ Python –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –ª–æ–≥ –≤ `run_full_ai_install_log.txt` / `run_lite_install_log.txt`.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (dev)
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -e .[dev]
```

## –ü—Ä–æ–≤–µ—Ä–∫–∏
```bash
ruff check app tests
black app tests
PYTHONPATH=. pytest -q
```

## –°–±–æ—Ä–∫–∞ EXE (Windows)
```bat
build\windows\build_win_exe.bat
```
–†–µ–∑—É–ª—å—Ç–∞—Ç: `dist\HistoAnalyzer\HistoAnalyzer.exe`

## –°–±–æ—Ä–∫–∞ Setup.exe (Inno Setup)
```bat
build\windows\build_win_setup.bat
```
–†–µ–∑—É–ª—å—Ç–∞—Ç: `release\Setup_HistoAnalyzer.exe`

Inno Setup: https://jrsoftware.org/isinfo.php

## –ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è `.histo`
–í `installer/HistoAnalyzer.iss`:
- `.histo` -> `HistoAnalyzer.Project`
- –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: `"{app}\HistoAnalyzer.exe" "%1"`

## –ú–µ–Ω–µ–¥–∂–µ—Ä –±—ç–∫–µ–Ω–¥–æ–≤ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
- –í UI –¥–æ—Å—Ç—É–ø–µ–Ω –≤—ã–±–æ—Ä: Fallback CV / Cellpose / ONNX.
- ONNX –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º `onnxruntime` –∏ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø—É—Ç–∏ –∫ –º–æ–¥–µ–ª–∏.

## Batch-mode
–í–æ –≤–∫–ª–∞–¥–∫–µ **üß≠ –ü–æ—à–∞–≥–æ–≤—ã–π –ò–ò**: –∫–Ω–æ–ø–∫–∞ **–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ä–µ—Ü–µ–ø—Ç—É**.
- –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π,
- –∑–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö QC/seg stage –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–∞–º,
- —Å–≤–æ–¥–Ω—ã–π CSV –ø–æ –ø–∞—Ä—Ç–∏–∏.


## –í–∏—Ç—Ä–∏–Ω–Ω–∞—è —Ñ–∏—á–∞ 1 ‚Äî ¬´–®—Ç–æ—Ä–∫–∞ –î–æ/–ü–æ—Å–ª–µ¬ª
- –í–∫–ª—é—á–∏—Ç–µ –≤ –º–µ–Ω—é **–í–∏–¥ ‚Üí –†–µ–∂–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—à—Ç–æ—Ä–∫–∞)** –∏–ª–∏ –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Ç—É–ª–±–∞—Ä–µ.
- –í—ã–±–µ—Ä–∏—Ç–µ **–°–ª–æ–π —Å–ª–µ–≤–∞** –∏ **–°–ª–æ–π —Å–ø—Ä–∞–≤–∞** (–æ—Ä–∏–≥–∏–Ω–∞–ª/–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ/–æ—Å–≤–µ—â–µ–Ω–∏–µ/—É–ª—É—á—à–µ–Ω–Ω–æ–µ).
- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —à—Ç–æ—Ä–∫—É –º—ã—à—å—é.
- –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ª–∏–Ω–∏–∏ —à—Ç–æ—Ä–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë –≤ —Ü–µ–Ω—Ç—Ä (50%).
- –í —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ON (xx%)`.

## –í–∏—Ç—Ä–∏–Ω–Ω–∞—è —Ñ–∏—á–∞ 2 ‚Äî ¬´–§–∏–≥—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç—å–∏ (1 –∫–ª–∏–∫)¬ª
–ú–µ–Ω—é **–§–∞–π–ª ‚Üí –≠–∫—Å–ø–æ—Ä—Ç ‚Üí –§–∏–≥—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç—å–∏‚Ä¶**:
- PNG/TIFF, —Ä–∞–∑–º–µ—Ä (—ç–∫—Ä–∞–Ω/A4 300/A4 600/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π),
- –≤—ã–±–æ—Ä —Å–ª–æ—ë–≤ –∏ –æ–≤–µ—Ä–ª–µ–µ–≤,
- –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –ª–µ–≥–µ–Ω–¥–∞, –ø–æ–¥–ø–∏—Å–∏,
- –º–∞—Å—à—Ç–∞–±–Ω–∞—è –ª–∏–Ω–µ–π–∫–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `um_per_px`),
- methods-–±–ª–æ–∫.

–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–µ–Ω–¥–µ—Ä–æ–º –≤ `QImage` –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º —ç–∫—Ä–∞–Ω–∞).


## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ GPU-–≤–µ–Ω–¥–æ—Ä—ã
–í **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶ ‚Üí –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
- –≤—ã–±–æ—Ä –≤–µ–Ω–¥–æ—Ä–∞: `Auto / NVIDIA / AMD / Intel / CPU`
- –∫–Ω–æ–ø–∫–∞ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–∫–æ—Ä–µ–Ω–∏–µ** (–º–∏–Ω–∏-–±–µ–Ω—á–º–∞—Ä–∫)
- –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/–±—ç–∫–µ–Ω–¥–∞:
  - NVIDIA: CUDA (torch)
  - AMD/Intel: DirectML (onnxruntime)
  - Intel: OpenVINO
  - fallback: CPU

### –ü–æ—á–µ–º—É AMD/Intel –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ CPU
–ï—Å–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã `onnxruntime-directml` –∏–ª–∏ `OpenVINO`, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ CPU. –≠—Ç–æ —à—Ç–∞—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è.

## –ú–æ–¥–µ–ª–∏ –ò–ò
–í **–ò–ò ‚Üí –ú–æ–¥–µ–ª–∏‚Ä¶**:
- —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ñ—Ñ–ª–∞–π–Ω-–ø–∞–∫–∞ `ModelPack.zip` (–æ–¥–∏–Ω —Ä–∞–∑),
- —Å—Ç–∞—Ç—É—Å—ã –ª–æ–∫–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏: Phikon-v2, Cellpose, StarDist, HoVer-Net, SAM,
- –∫–Ω–æ–ø–∫–∏: –°–∫–∞—á–∞—Ç—å / –ü—Ä–æ–≤–µ—Ä–∏—Ç—å / –£–¥–∞–ª–∏—Ç—å,
- –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏.

–ü—É—Ç—å –∫ –∫—ç—à—É –º–æ–¥–µ–ª–µ–π:
- Windows: `%LOCALAPPDATA%\HistoAnalyzer\models`
- Linux/macOS: `~/.cache/HistoAnalyzer/models`

## –ò–Ω—Å—Ç–∞–ª–ª—è—Ç–æ—Ä –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π
–í Inno Setup –¥–æ–±–∞–≤–ª–µ–Ω —á–µ–∫–±–æ–∫—Å **¬´–°–∫–∞—á–∞—Ç—å –º–æ–¥–µ–ª–∏ –ò–ò (–æ–¥–∏–Ω —Ä–∞–∑, –∑–∞—Ç–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω)¬ª**.
- –∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥—ë—Ç –≤ `%LOCALAPPDATA%\HistoAnalyzer\models`;
- –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç, –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ –¥–æ–∫–∞—á–∞—Ç—å –ø–æ–∑–∂–µ –∏–∑ —ç–∫—Ä–∞–Ω–∞ **–ò–ò ‚Üí –ú–æ–¥–µ–ª–∏**.


–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ –æ—Ñ—Ñ–ª–∞–π–Ω-–º–æ–¥–µ–ª—è–º: `README_RU.md`.
